<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-07-28T09:05:04.299602"><title>Chapitre 6 : Tester les Fondations : La Couche d'Acc&egrave;s aux Donn&eacute;es | Java Spring Test</title><script type="application/json" id="virtual-toc-data">[{"id":"objectifs-p-dagogiques","level":0,"title":"Objectifs pédagogiques","anchor":"#objectifs-p-dagogiques"},{"id":"introduction-l-archiviste-m-ticuleux","level":0,"title":"Introduction : L\u0027archiviste méticuleux","anchor":"#introduction-l-archiviste-m-ticuleux"},{"id":"datajpatest-le-test-en-tranche-pour-la-persistance","level":0,"title":"@DataJpaTest : Le Test en Tranche pour la Persistance","anchor":"#datajpatest-le-test-en-tranche-pour-la-persistance"},{"id":"testentitymanager-votre-assistant-pour-la-gestion-des-entit-s","level":0,"title":"TestEntityManager : Votre Assistant pour la Gestion des Entités","anchor":"#testentitymanager-votre-assistant-pour-la-gestion-des-entit-s"},{"id":"tester-une-requ-te-personnalis-e","level":0,"title":"Tester une Requête Personnalisée","anchor":"#tester-une-requ-te-personnalis-e"},{"id":"le-rollback-transactionnel-automatique","level":0,"title":"Le Rollback Transactionnel Automatique","anchor":"#le-rollback-transactionnel-automatique"},{"id":"exercice-9-tester-une-requ-te-de-recherche-complexe","level":0,"title":"Exercice 9 : Tester une requête de recherche complexe","anchor":"#exercice-9-tester-une-requ-te-de-recherche-complexe"},{"id":"correction-exercice-9","level":0,"title":"Correction exercice 9","anchor":"#correction-exercice-9"},{"id":"auto-valuation","level":0,"title":"Auto-évaluation","anchor":"#auto-valuation"},{"id":"conclusion-de-la-partie","level":0,"title":"Conclusion de la partie","anchor":"#conclusion-de-la-partie"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Chapitre 6 : Tester les Fondations : La Couche d'Acc&egrave;s aux Donn&eacute;es | Java Spring Test"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Java Spring Test Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/006-00-database-testing.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Chapitre 6 : Tester les Fondations : La Couche d'Acc&egrave;s aux Donn&eacute;es | Java Spring Test"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/006-00-database-testing.html#webpage",
    "url": "writerside-documentation/006-00-database-testing.html",
    "name": "Chapitre 6 : Tester les Fondations : La Couche d'Acc&egrave;s aux Donn&eacute;es | Java Spring Test",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Java Spring Test Help"
}</script><!-- End Schema.org --></head><body data-id="006-00-database-testing" data-main-title="Chapitre 6 : Tester les Fondations : La Couche d'Accès aux Données" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs=""><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Java Spring Test  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="006-00-database-testing" id="006-00-database-testing.md">Chapitre 6 : Tester les Fondations : La Couche d'Accès aux Données</h1><section class="chapter"><h2 id="objectifs-p-dagogiques" data-toc="objectifs-p-dagogiques">Objectifs p&eacute;dagogiques</h2><p id="-f1bnkv_13">&Agrave; la fin de cette partie, vous serez en mesure de :</p><ul class="list _bullet" id="-f1bnkv_14"><li class="list__item" id="-f1bnkv_15"><p id="-f1bnkv_20"><span class="control" id="-f1bnkv_21">Utiliser</span> le test en tranche <code class="code" id="-f1bnkv_22">@DataJpaTest</code> pour tester vos repositories JPA.</p></li><li class="list__item" id="-f1bnkv_16"><p id="-f1bnkv_23"><span class="control" id="-f1bnkv_24">Expliquer</span> le r&ocirc;le de la base de donn&eacute;es en m&eacute;moire (H2) dans les tests de persistance.</p></li><li class="list__item" id="-f1bnkv_17"><p id="-f1bnkv_25"><span class="control" id="-f1bnkv_26">Manipuler</span> des entit&eacute;s dans un contexte de test avec <code class="code" id="-f1bnkv_27">TestEntityManager</code>.</p></li><li class="list__item" id="-f1bnkv_18"><p id="-f1bnkv_28"><span class="control" id="-f1bnkv_29">Comprendre</span> le comportement transactionnel par d&eacute;faut des tests <code class="code" id="-f1bnkv_30">@DataJpaTest</code> et son impact.</p></li><li class="list__item" id="-f1bnkv_19"><p id="-f1bnkv_31"><span class="control" id="-f1bnkv_32">&Eacute;crire</span> des tests pour valider les requ&ecirc;tes personnalis&eacute;es de vos repositories.</p></li></ul></section><section class="chapter"><h2 id="introduction-l-archiviste-m-ticuleux" data-toc="introduction-l-archiviste-m-ticuleux">Introduction : L'archiviste m&eacute;ticuleux</h2><p id="-f1bnkv_33">Imaginez que votre application est une immense biblioth&egrave;que. Nous avons test&eacute; le biblioth&eacute;caire en chef (<code class="code" id="-f1bnkv_36">Service</code>) qui conna&icirc;t toutes les r&egrave;gles de pr&ecirc;t et le r&eacute;ceptionniste (<code class="code" id="-f1bnkv_37">Controller</code>) qui accueille les visiteurs. Mais qui s'assure que lorsque l'on demande le livre &quot;Codex Seraphinianus&quot;, on ne re&ccedil;oit pas &quot;Martine &agrave; la ferme&quot; ? Qui garantit que les livres sont rang&eacute;s au bon endroit et que l'on peut les retrouver ?</p><p id="-f1bnkv_34">C'est le r&ocirc;le de l'archiviste : la couche de persistance (<code class="code" id="-f1bnkv_38">Repository</code>). Son travail est crucial. Il doit comprendre parfaitement le syst&egrave;me de classement (JPA, SQL) et &ecirc;tre capable de stocker et de r&eacute;cup&eacute;rer des informations sans erreur.</p><p id="-f1bnkv_35">Tester la couche d'acc&egrave;s aux donn&eacute;es, c'est v&eacute;rifier le travail de cet archiviste. On ne teste pas la logique m&eacute;tier ( &ccedil;a, c'est le r&ocirc;le du service), mais on teste si nos requ&ecirc;tes et nos m&eacute;thodes de repository dialoguent correctement avec la base de donn&eacute;es. Pour cela, on va lui donner quelques livres, lui demander de les ranger, puis de nous les retrouver.</p></section><section class="chapter"><h2 id="datajpatest-le-test-en-tranche-pour-la-persistance" data-toc="datajpatest-le-test-en-tranche-pour-la-persistance"><code class="code" id="-f1bnkv_44">@DataJpaTest</code>: Le Test en Tranche pour la Persistance</h2><p id="-f1bnkv_40">Tout comme <code class="code" id="-f1bnkv_45">@WebMvcTest</code> cr&eacute;ait un &quot;slice&quot; pour la couche web, <code class="code" id="-f1bnkv_46">@DataJpaTest</code> cr&eacute;e une tranche optimis&eacute;e pour tester la couche JPA.</p><p id="-f1bnkv_41">Quand vous utilisez <code class="code" id="-f1bnkv_47">@DataJpaTest</code>, Spring Boot configure un environnement minimaliste mais puissant :</p><ul class="list _bullet" id="-f1bnkv_42"><li class="list__item" id="-f1bnkv_48"><p id="-f1bnkv_52">Il configure une <span class="control" id="-f1bnkv_53">base de donn&eacute;es en m&eacute;moire (H2)</span> par d&eacute;faut. C'est ultra-rapide et ne n&eacute;cessite aucune installation.</p></li><li class="list__item" id="-f1bnkv_49"><p id="-f1bnkv_54">Il scanne vos entit&eacute;s (<code class="code" id="-f1bnkv_55">@Entity</code>) et vos repositories Spring Data (<code class="code" id="-f1bnkv_56">@Repository</code>).</p></li><li class="list__item" id="-f1bnkv_50"><p id="-f1bnkv_57">Il <span class="control" id="-f1bnkv_58">ne charge PAS</span> les autres beans comme les <code class="code" id="-f1bnkv_59">@Service</code>, <code class="code" id="-f1bnkv_60">@Controller</code> ou <code class="code" id="-f1bnkv_61">@Component</code>.</p></li><li class="list__item" id="-f1bnkv_51"><p id="-f1bnkv_62">Chaque test est ex&eacute;cut&eacute; dans une <span class="control" id="-f1bnkv_63">transaction qui est automatiquement annul&eacute;e (rollback)</span> &agrave; la fin. Cela garantit que chaque test est ind&eacute;pendant et ne pollue pas la base de donn&eacute;es pour les tests suivants.</p></li></ul><style>.theme-dark .plantuml > svg {filter: hue-rotate(180deg) invert(0.9);}div.plantuml {overflow-x: auto;}</style><div class="plantuml"><?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="358px" preserveAspectRatio="none" style="width:1230px;height:358px;background:#FFFFFF;" version="1.1" viewBox="0 0 1230 358" width="1230px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="260" x="478" y="23.5352">Contexte de test avec @DataJpaTest</text><!--cluster Contexte Spring Data JPA--><g id="cluster_Contexte Spring Data JPA"><path d="M9.5,88.6683 L191.5,88.6683 A5.25,5.25 0 0 1 195,92.1683 L202,111.1566 L586.5,111.1566 A3.5,3.5 0 0 1 590,114.6566 L590,347.8683 A3.5,3.5 0 0 1 586.5,351.3683 L9.5,351.3683 A3.5,3.5 0 0 1 6,347.8683 L6,92.1683 A3.5,3.5 0 0 1 9.5,88.6683 " fill="#ADD8E6" style="stroke:#696969;stroke-width:1.0;"/><line style="stroke:#696969;stroke-width:1.0;" x1="6" x2="202" y1="111.1566" y2="111.1566"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="183" x="10" y="104.2034">Contexte Spring Data JPA</text></g><!--cluster Hors du Contexte--><g id="cluster_Hors du Contexte"><path d="M893.5,96.6683 L1018.5,96.6683 A5.25,5.25 0 0 1 1022,100.1683 L1029,119.1566 L1219.5,119.1566 A3.5,3.5 0 0 1 1223,122.6566 L1223,190.6583 A3.5,3.5 0 0 1 1219.5,194.1583 L893.5,194.1583 A3.5,3.5 0 0 1 890,190.6583 L890,100.1683 A3.5,3.5 0 0 1 893.5,96.6683 " fill="#D3D3D3" style="stroke:#696969;stroke-width:1.0;"/><line style="stroke:#696969;stroke-width:1.0;" x1="890" x2="1029" y1="119.1566" y2="119.1566"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="126" x="894" y="112.2034">Hors du Contexte</text></g><!--cluster Base de Donn?es--><g id="cluster_Base de Donn&#233;es"><path d="M625.5,245.8783 L746.5,245.8783 A5.25,5.25 0 0 1 750,249.3783 L757,268.3666 L914.5,268.3666 A3.5,3.5 0 0 1 918,271.8666 L918,339.8683 A3.5,3.5 0 0 1 914.5,343.3683 L625.5,343.3683 A3.5,3.5 0 0 1 622,339.8683 L622,249.3783 A3.5,3.5 0 0 1 625.5,245.8783 " fill="none" style="stroke:#696969;stroke-width:1.0;"/><line style="stroke:#696969;stroke-width:1.0;" x1="622" x2="757" y1="268.3666" y2="268.3666"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="122" x="626" y="261.4134">Base de Donn&#233;es</text></g><!--entity BookRepository--><g id="elem_BookRepository"><rect fill="#F1F1F1" height="46.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="147" x="30.5" y="131.6683"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="157.5" y="136.6683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="155.5" y="138.6683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="155.5" y="142.6683"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="45.5" y="165.2034">BookRepository</text></g><!--entity AuthorRepository--><g id="elem_AuthorRepository"><rect fill="#F1F1F1" height="46.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="161" x="212.5" y="131.6683"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="353.5" y="136.6683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="351.5" y="138.6683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="351.5" y="142.6683"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="121" x="227.5" y="165.2034">AuthorRepository</text></g><!--entity EntityManager--><g id="elem_EntityManager"><rect fill="#F1F1F1" height="46.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="138" x="409" y="131.6683"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="527" y="136.6683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="525" y="138.6683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="525" y="142.6683"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="424" y="165.2034">EntityManager</text></g><!--entity DataSource--><g id="elem_DataSource"><rect fill="#F1F1F1" height="46.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="118" x="234" y="280.8783"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="332" y="285.8783"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="330" y="287.8783"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="330" y="291.8783"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78" x="249" y="314.4134">DataSource</text></g><!--entity BookService--><g id="elem_BookService"><rect fill="#F1F1F1" height="46.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="122" x="906" y="131.6683"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="1008" y="136.6683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="1006" y="138.6683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="1006" y="142.6683"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="82" x="921" y="165.2034">BookService</text></g><!--entity BookController--><g id="elem_BookController"><rect fill="#F1F1F1" height="46.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="144" x="1063" y="131.6683"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="1187" y="136.6683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="1185" y="138.6683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="1185" y="142.6683"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="104" x="1078" y="165.2034">BookController</text></g><!--entity Base de donn?es H2 en m?moire--><g id="elem_Base de donn&#233;es H2 en m&#233;moire"><rect fill="#F1F1F1" height="46.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="264" x="638" y="280.8783"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="882" y="285.8783"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="880" y="287.8783"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="880" y="291.8783"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="224" x="653" y="314.4134">Base de donn&#233;es H2 en m&#233;moire</text></g><g id="elem_GMN13"><path d="M617,130.4483 L617,179.3799 A3.5,3.5 0 0 0 620.5,182.8799 L867.5,182.8799 A3.5,3.5 0 0 0 871,179.3799 L871,136.9483 L861,126.9483 L620.5,126.9483 A3.5,3.5 0 0 0 617,130.4483 " fill="#7FFFD4" style="stroke:#454645;stroke-width:1.5;"/><path d="M861,126.9483 L861,135.1983 A1.75,1.75 0 0 0 862.75,136.9483 L871,136.9483 L861,126.9483 " fill="#7FFFD4" style="stroke:#454645;stroke-width:1.0;"/><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="623" y="144.5166">Les Repositories sont de vrais beans,</text><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="623" y="159.8272">connect&#233;s &#224; une vraie BDD (H2).</text><text fill="#454645" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="623" y="175.1377">Pas de mocks ici !</text></g><!--link Contexte Spring Data JPA to Base de donn?es H2 en m?moire--><g id="link_Contexte Spring Data JPA_Base de donn&#233;es H2 en m&#233;moire"><path d="M590.0341,186.9212 C590.1002,187.0767 590.1668,187.2322 590.234,187.3875 C590.3682,187.6982 590.5046,188.0084 590.643,188.3181 C592.8575,193.2733 595.605,198.0858 599,202.1583 C628.69,237.7783 674.38,263.8383 711.07,280.5583 " fill="none" id="Contexte Spring Data JPA-Base de donn&#233;es H2 en m&#233;moire" style="stroke:#454645;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="54" x="626.67" y="226.4466">dialogue</text></g><!--link BookRepository to GMN13--><g id="link_BookRepository_GMN13"><path d="M121.24,131.3983 C140.42,107.4883 173.83,71.9783 212.5,57.6683 C250.85,43.4883 541.07,46.8283 580.5,57.6683 C629.06,71.0183 677.79,102.9783 709.25,126.6283 " fill="none" id="BookRepository-GMN13" style="stroke:#454645;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/></g><!--SRC=[XP31JiCm44Jl_effk814EVJ8YOOWggf85ULMzM2S9RMQU2FRYQWG_yArtv4VmsvJA4Y8uuvctypkmA-f8hJwsKhZXTU-92ItR3ozUa9EyEGyP4iADvdqSbhBfw0aGjHIRMHnwbxKLfi2qORfV9pWRAQBjK_BXl0cW6NAl7cacftsRBUhA8qRlsRxIxmpeSZsGPh0jtibCXVSM4KhyNwIFM7ha3SuTZXctbkv_SvSa6rrNEtdwBPSbX5-Iakbsz-SiJ7TZbpI8tevxsLCHY23gjjLhEsXqVAlBwmm7FwFm3LoBKik6XB2SC3OU0Ru1J-V5lhCmlgNeCFWGdI4jrPgXsUInbq6dmfPf7otS-W-q9Y3WP1c6Sudeukhu9bB5pShLXi7hJG6WaoEsE0J]--></g></svg></div></section><section class="chapter"><h2 id="testentitymanager-votre-assistant-pour-la-gestion-des-entit-s" data-toc="testentitymanager-votre-assistant-pour-la-gestion-des-entit-s"><code class="code" id="-f1bnkv_70">TestEntityManager</code>: Votre Assistant pour la Gestion des Entit&eacute;s</h2><p id="-f1bnkv_65">Dans un test <code class="code" id="-f1bnkv_71">@DataJpaTest</code>, comment ins&eacute;rer des donn&eacute;es pour pouvoir ensuite les tester ? C'est l&agrave; qu'intervient le <code class="code" id="-f1bnkv_72">TestEntityManager</code>. C'est un wrapper autour de l' <code class="code" id="-f1bnkv_73">EntityManager</code> de JPA, mais avec des m&eacute;thodes simplifi&eacute;es, sp&eacute;cialement con&ccedil;ues pour les tests.</p><p id="-f1bnkv_66">Il vous permet de :</p><ul class="list _bullet" id="-f1bnkv_67"><li class="list__item" id="-f1bnkv_74"><p id="-f1bnkv_78"><code class="code" id="-f1bnkv_79">persist(entity)</code>: Sauvegarder une entit&eacute; en base.</p></li><li class="list__item" id="-f1bnkv_75"><p id="-f1bnkv_80"><code class="code" id="-f1bnkv_81">flush()</code>: Forcer la synchronisation entre le contexte de persistance et la base de donn&eacute;es (ex&eacute;cuter les requ&ecirc;tes SQL en attente).</p></li><li class="list__item" id="-f1bnkv_76"><p id="-f1bnkv_82"><code class="code" id="-f1bnkv_83">find(class, id)</code>: Retrouver une entit&eacute; par son ID.</p></li><li class="list__item" id="-f1bnkv_77"><p id="-f1bnkv_84"><code class="code" id="-f1bnkv_85">persistAndFlush(entity)</code>: Une combinaison pratique des deux premi&egrave;res m&eacute;thodes.</p></li></ul><div class="code-block" data-lang="java">
// src/test/java/fr/formation/spring/repository/BookRepositoryTest.java
package fr.formation.spring.repository;

import fr.formation.spring.entity.Book;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.boot.test.autoconfigure.orm.jpa.TestEntityManager;

import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
class BookRepositoryTest {

    @Autowired
    private TestEntityManager entityManager; // L'assistant pour les entités

    @Autowired
    private BookRepository bookRepository; // Le repository à tester

    @Test
    void findById_shouldReturnBook_whenBookExists() {
        // Arrange : On crée et on persiste un livre
        Book bookToSave = new Book(&quot;Le Mythe de Cthulhu&quot;, &quot;H.P. Lovecraft&quot;);
        Book savedBook = entityManager.persistAndFlush(bookToSave);

        // Act : On utilise le repository pour le retrouver
        Optional&lt;Book&gt; foundBookOpt = bookRepository.findById(savedBook.getId());

        // Assert : On vérifie le résultat
        assertThat(foundBookOpt).isPresent();
        assertThat(foundBookOpt.get().getTitle()).isEqualTo(bookToSave.getTitle());
    }
}
</div><aside class="prompt" data-type="warning" data-title="" id="-f1bnkv_69"><p>**Pourquoi `persistAndFlush` ?** En JPA, l'appel &agrave; `persist` ne d&eacute;clenche pas forc&eacute;ment un `INSERT` imm&eacute;diat. La requ&ecirc;te peut &ecirc;tre mise en attente. `flush` force l'envoi de la requ&ecirc;te &agrave; la base de donn&eacute;es, ce qui garantit que les donn&eacute;es sont bien pr&eacute;sentes quand votre repository va essayer de les lire.</p></aside></section><section class="chapter"><h2 id="tester-une-requ-te-personnalis-e" data-toc="tester-une-requ-te-personnalis-e">Tester une Requ&ecirc;te Personnalis&eacute;e</h2><p id="-f1bnkv_86">Le v&eacute;ritable int&eacute;r&ecirc;t de tester les repositories appara&icirc;t lorsque vous &eacute;crivez vos propres requ&ecirc;tes. Spring Data JPA fait beaucoup de magie pour vous, mais c'est &agrave; vous de garantir que vos requ&ecirc;tes personnalis&eacute;es (en JPQL ou via les noms de m&eacute;thodes) sont correctes.</p><p id="-f1bnkv_87">Imaginons que nous ajoutions une m&eacute;thode pour trouver des livres par auteur dans notre <code class="code" id="-f1bnkv_91">BookRepository</code>.</p><div class="code-block" data-lang="java">
// fr.formation.spring.repository.BookRepository.java
public interface BookRepository extends JpaRepository&lt;Book, Long&gt; {
    // Requête générée par le nom de la méthode
    List&lt;Book&gt; findByAuthor(String author);

    // Requête personnalisée avec @Query
    @Query(&quot;SELECT b FROM Book b WHERE b.title LIKE %:keyword%&quot;)
    List&lt;Book&gt; searchByTitleKeyword(@Param(&quot;keyword&quot;) String keyword);
}
</div><p id="-f1bnkv_89"><span class="control" id="-f1bnkv_92">Le test pour <code class="code" id="-f1bnkv_93">findByAuthor</code>:</span></p><div class="code-block" data-lang="java">
// Dans BookRepositoryTest.java

@Test
void findByAuthor_shouldReturnBooksForGivenAuthor() {
    // Arrange
    entityManager.persist(new Book(&quot;L'Appel de Cthulhu&quot;, &quot;H.P. Lovecraft&quot;));
    entityManager.persist(new Book(&quot;Les Montagnes Hallucinées&quot;, &quot;H.P. Lovecraft&quot;));
    entityManager.persist(new Book(&quot;Le Roi en Jaune&quot;, &quot;R.W. Chambers&quot;));
    entityManager.flush();

    // Act
    List&lt;Book&gt; lovecraftBooks = bookRepository.findByAuthor(&quot;H.P. Lovecraft&quot;);

    // Assert
    assertThat(lovecraftBooks).hasSize(2)
            .allMatch(b -&gt; b.getAuthor().equals(&quot;H.P. Lovecraft&quot;));
}
</div></section><section class="chapter"><h2 id="le-rollback-transactionnel-automatique" data-toc="le-rollback-transactionnel-automatique">Le Rollback Transactionnel Automatique</h2><p id="-f1bnkv_94">Par d&eacute;faut, <code class="code" id="-f1bnkv_98">@DataJpaTest</code> est annot&eacute; avec <code class="code" id="-f1bnkv_99">@Transactional</code>. Dans un contexte de test, cela a un comportement sp&eacute;cial : <span class="control" id="-f1bnkv_100">toute modification faite &agrave; la base de donn&eacute;es est annul&eacute;e (rollback) &agrave; la fin de la m&eacute;thode de test.</span></p><p id="-f1bnkv_95">C'est une fonctionnalit&eacute; g&eacute;niale, car elle garantit que chaque test s'ex&eacute;cute sur une base de donn&eacute;es &quot;propre&quot;, sans avoir besoin d'&eacute;crire du code de nettoyage.</p><div class="code-block" data-lang="java">

@Test
void test1() {
    // Arrange: on insère un livre
    entityManager.persistAndFlush(new Book(&quot;Titre 1&quot;, &quot;Auteur 1&quot;));
    // Le livre existe ici
}
// FIN de test1: la transaction est annulée, le livre est supprimé.

@Test
void test2() {
    // Le livre inséré dans test1 N'EXISTE PAS ici.
    // La base est revenue à son état initial.
    long count = bookRepository.count();
    assertThat(count).isEqualTo(0); // (en supposant la base vide au départ)
}
</div><p id="-f1bnkv_97">Si jamais vous avez besoin de d&eacute;sactiver ce comportement (cas tr&egrave;s rare), vous pouvez annoter votre test avec <code class="code" id="-f1bnkv_101">@Rollback(false)</code>.</p></section><section class="chapter"><h2 id="exercice-9-tester-une-requ-te-de-recherche-complexe" data-toc="exercice-9-tester-une-requ-te-de-recherche-complexe">Exercice 9 : Tester une requ&ecirc;te de recherche complexe</h2><p id="-f1bnkv_102">Vous voulez ajouter une fonctionnalit&eacute; de recherche &agrave; votre <code class="code" id="-f1bnkv_105">BookRepository</code>. La m&eacute;thode doit trouver tous les livres qui contiennent un mot-cl&eacute; dans leur titre ET qui sont marqu&eacute;s comme &quot;best-seller&quot;.</p><p id="-f1bnkv_103"><span class="control" id="-f1bnkv_106">Votre mission :</span></p><ol class="list _decimal" id="-f1bnkv_104" type="1"><li class="list__item" id="-f1bnkv_107"><p id="-f1bnkv_112">Ajoutez la m&eacute;thode suivante &agrave; votre interface <code class="code" id="-f1bnkv_114">BookRepository</code> (vous devrez ajouter le champ <code class="code" id="-f1bnkv_115">isBestSeller</code> &agrave; votre entit&eacute; <code class="code" id="-f1bnkv_116">Book</code> si ce n'est pas d&eacute;j&agrave; fait) :</p><div class="code-block" data-lang="java">
@Query(&quot;SELECT b FROM Book b WHERE b.isBestSeller = true AND &quot; +
       &quot;LOWER(b.title) LIKE LOWER(CONCAT('%', :keyword, '%'))&quot;)
List&lt;Book&gt; findBestSellersByTitleKeyword(@Param(&quot;keyword&quot;) String keyword);
</div></li><li class="list__item" id="-f1bnkv_108"><p id="-f1bnkv_117">Dans votre classe <code class="code" id="-f1bnkv_118">BookRepositoryTest</code>, &eacute;crivez un test pour cette nouvelle m&eacute;thode.</p></li><li class="list__item" id="-f1bnkv_109"><p id="-f1bnkv_119">Utilisez <code class="code" id="-f1bnkv_121">TestEntityManager</code> pour persister plusieurs livres :</p><ul class="list _bullet" id="-f1bnkv_120"><li class="list__item" id="-f1bnkv_122"><p id="-f1bnkv_125">Un best-seller dont le titre correspond au mot-cl&eacute;.</p></li><li class="list__item" id="-f1bnkv_123"><p id="-f1bnkv_126">Un livre normal (non best-seller) dont le titre correspond.</p></li><li class="list__item" id="-f1bnkv_124"><p id="-f1bnkv_127">Un best-seller dont le titre ne correspond pas.</p></li></ul></li><li class="list__item" id="-f1bnkv_110"><p id="-f1bnkv_128">Appelez votre nouvelle m&eacute;thode de repository avec un mot-cl&eacute; pertinent.</p></li><li class="list__item" id="-f1bnkv_111"><p id="-f1bnkv_129">Utilisez AssertJ pour v&eacute;rifier que la liste retourn&eacute;e contient <span class="control" id="-f1bnkv_130">exactement un livre</span>, et que c'est bien le bon.</p></li></ol></section><section class="chapter"><div class="collapse"><div class="collapse__title"><h2 id="correction-exercice-9" data-toc="correction-exercice-9">Correction exercice 9</h2></div><div class="collapse__content"><div class="code-block" data-lang="java">
// Entité Book modifiée
// @Entity
// public class Book {
//     // ... id, title, author
//     private boolean isBestSeller;
// }

// src/test/java/fr/formation/spring/repository/BookRepositoryTest.java
@DataJpaTest
class BookRepositoryTest {

    // ... @Autowired TestEntityManager, BookRepository

    @Test
    @DisplayName(&quot;Devrait trouver les best-sellers contenant un mot-clé dans le titre&quot;)
    void findBestSellersByTitleKeyword_shouldReturnMatchingBestSellers() {
        // Arrange
        entityManager.persist(new Book(&quot;Java pour les Nuls&quot;, &quot;Barry Burd&quot;, true)); // Correspond
        entityManager.persist(new Book(&quot;Spring en Action&quot;, &quot;Craig Walls&quot;, true)); // Ne correspond pas
        entityManager.persist(new Book(&quot;Le Guide Complet Java&quot;, &quot;H. Schildt&quot;, false)); // Correspond mais pas best-seller
        entityManager.persist(new Book(&quot;Un autre livre&quot;, &quot;Quelqu'un&quot;, false)); // Ne correspond pas
        entityManager.flush();

        // Act
        List&lt;Book&gt; results = bookRepository.findBestSellersByTitleKeyword(&quot;java&quot;);

        // Assert
        assertThat(results).isNotNull();
        assertThat(results).hasSize(1);

        Book foundBook = results.get(0);
        assertThat(foundBook.getTitle()).isEqualTo(&quot;Java pour les Nuls&quot;);
        assertThat(foundBook.isBestSeller()).isTrue();
    }
}
</div></div></div></section><section class="chapter"><h2 id="auto-valuation" data-toc="auto-valuation">Auto-&eacute;valuation</h2><ol class="list _decimal" id="-f1bnkv_132" type="1"><li class="list__item" id="-f1bnkv_134"><p id="-f1bnkv_139">(Question ouverte) Quel est le r&ocirc;le principal de <code class="code" id="-f1bnkv_140">@DataJpaTest</code> et quelles sont les deux configurations cl&eacute;s qu'il met en place par d&eacute;faut ?</p></li><li class="list__item" id="-f1bnkv_135"><p id="-f1bnkv_141">(QCM) Dans un test <code class="code" id="-f1bnkv_143">@DataJpaTest</code>, pourquoi le rollback automatique des transactions est-il utile ?</p><ul class="list _bullet" id="-f1bnkv_142"><li class="list__item" id="-f1bnkv_144"><p id="-f1bnkv_148">a) Pour am&eacute;liorer les performances des tests.</p></li><li class="list__item" id="-f1bnkv_145"><p id="-f1bnkv_149">b) Pour s'assurer que les donn&eacute;es de test sont bien sauvegard&eacute;es en base.</p></li><li class="list__item" id="-f1bnkv_146"><p id="-f1bnkv_150">c) Pour garantir l'isolation des tests en nettoyant la base de donn&eacute;es apr&egrave;s chaque test.</p></li><li class="list__item" id="-f1bnkv_147"><p id="-f1bnkv_151">d) Pour &eacute;viter les erreurs de type <code class="code" id="-f1bnkv_152">LazyInitializationException</code>.</p></li></ul></li><li class="list__item" id="-f1bnkv_136"><p id="-f1bnkv_153">(Question ouverte) Quelle est la diff&eacute;rence entre <code class="code" id="-f1bnkv_154">entityManager.persist()</code> et <code class="code" id="-f1bnkv_155">entityManager.persistAndFlush()</code>? Dans quel cas utiliser ce dernier ?</p></li><li class="list__item" id="-f1bnkv_137"><p id="-f1bnkv_156">(QCM) Lorsque vous utilisez <code class="code" id="-f1bnkv_158">@DataJpaTest</code>, quels beans de votre application sont charg&eacute;s dans le contexte de test ?</p><ul class="list _bullet" id="-f1bnkv_157"><li class="list__item" id="-f1bnkv_159"><p id="-f1bnkv_163">a) Tous les beans (<code class="code" id="-f1bnkv_164">@Controller</code>, <code class="code" id="-f1bnkv_165">@Service</code>, <code class="code" id="-f1bnkv_166">@Repository</code>).</p></li><li class="list__item" id="-f1bnkv_160"><p id="-f1bnkv_167">b) Uniquement les <code class="code" id="-f1bnkv_168">@Controller</code>.</p></li><li class="list__item" id="-f1bnkv_161"><p id="-f1bnkv_169">c) Uniquement les <code class="code" id="-f1bnkv_170">@Repository</code> JPA, les <code class="code" id="-f1bnkv_171">@Entity</code> et l'infrastructure de persistance.</p></li><li class="list__item" id="-f1bnkv_162"><p id="-f1bnkv_172">d) Uniquement les <code class="code" id="-f1bnkv_173">@Service</code>.</p></li></ul></li><li class="list__item" id="-f1bnkv_138"><p id="-f1bnkv_174">(QCM) <code class="code" id="-f1bnkv_176">TestEntityManager</code> est...</p><ul class="list _bullet" id="-f1bnkv_175"><li class="list__item" id="-f1bnkv_177"><p id="-f1bnkv_181">a) Un mock de l' <code class="code" id="-f1bnkv_182">EntityManager</code>.</p></li><li class="list__item" id="-f1bnkv_178"><p id="-f1bnkv_183">b) Une alternative &agrave; l'utilisation d'un <code class="code" id="-f1bnkv_184">Repository</code>.</p></li><li class="list__item" id="-f1bnkv_179"><p id="-f1bnkv_185">c) Une classe utilitaire fournie par Spring Test pour simplifier la manipulation des entit&eacute;s JPA dans les tests.</p></li><li class="list__item" id="-f1bnkv_180"><p id="-f1bnkv_186">d) Un outil pour &eacute;crire des requ&ecirc;tes SQL natives.</p></li></ul></li></ol><p id="-f1bnkv_133"><span class="emphasis" id="-f1bnkv_187">(Les corrections de l'auto-&eacute;valuation seront fournies &agrave; la toute fin du support de cours.)</span></p></section><section class="chapter"><h2 id="conclusion-de-la-partie" data-toc="conclusion-de-la-partie">Conclusion de la partie</h2><p id="-f1bnkv_188">Vous avez solidifi&eacute; les fondations ! Vous savez maintenant comment tester la couche la plus basse, mais la plus critique de votre application. Avec <code class="code" id="-f1bnkv_190">@DataJpaTest</code>, vous pouvez cr&eacute;er un environnement de test de persistance isol&eacute; et rapide. Vous ma&icirc;trisez le <code class="code" id="-f1bnkv_191">TestEntityManager</code> pour pr&eacute;parer vos donn&eacute;es et, plus important encore, vous pouvez &eacute;crire des tests cibl&eacute;s pour valider que vos requ&ecirc;tes personnalis&eacute;es se comportent exactement comme vous le souhaitez.</p><p id="-f1bnkv_189">Vous avez maintenant explor&eacute; les tests par tranches pour les services, la couche web et la couche de donn&eacute;es. Dans le prochain chapitre, nous allons remonter &agrave; la surface et assembler toutes les pi&egrave;ces. Nous verrons quand et comment utiliser <code class="code" id="-f1bnkv_192">@SpringBootTest</code> pour r&eacute;aliser des tests d'int&eacute;gration complets, simulant un flux de bout en bout au sein de votre microservice.</p></section><div class="last-modified">21 juillet 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="005-00-testing-rest.html" class="navigation-links__prev">Chapitre 5 : Tester la Fa&ccedil;ade : Les Contr&ocirc;leurs REST</a><a href="007-00-integration-testing.html" class="navigation-links__next">Chapitre 7 : L'&Eacute;preuve du Feu : Tests d'Int&eacute;gration Complets</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>