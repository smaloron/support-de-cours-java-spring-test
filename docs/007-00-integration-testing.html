<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-06-27T16:25:10.783986"><title>Chapitre 7 : L'&Eacute;preuve du Feu : Tests d'Int&eacute;gration Complets (L'essentiel) | Java Spring Test</title><script type="application/json" id="virtual-toc-data">[{"id":"objectifs-p-dagogiques","level":0,"title":"Objectifs pédagogiques","anchor":"#objectifs-p-dagogiques"},{"id":"introduction-le-grand-final-de-la-r-p-tition-g-n-rale","level":0,"title":"Introduction : Le grand final de la répétition générale","anchor":"#introduction-le-grand-final-de-la-r-p-tition-g-n-rale"},{"id":"quand-utiliser-springboottest-pour-un-test-complet","level":0,"title":"Quand utiliser @SpringBootTest pour un test complet ?","anchor":"#quand-utiliser-springboottest-pour-un-test-complet"},{"id":"mise-en-place-de-l-environnement","level":0,"title":"Mise en Place de l\u0027Environnement","anchor":"#mise-en-place-de-l-environnement"},{"id":"mockmvc-vs-testresttemplate-le-duel","level":0,"title":"MockMvc vs. TestRestTemplate : Le Duel","anchor":"#mockmvc-vs-testresttemplate-le-duel"},{"id":"exemple-tester-le-flux-de-cr-ation-de-livre","level":0,"title":"Exemple : Tester le flux de création de livre","anchor":"#exemple-tester-le-flux-de-cr-ation-de-livre"},{"id":"exercice-10-tester-un-flux-de-recherche","level":0,"title":"Exercice 10 : Tester un flux de recherche","anchor":"#exercice-10-tester-un-flux-de-recherche"},{"id":"correction-exercice-10","level":0,"title":"Correction exercice 10","anchor":"#correction-exercice-10"},{"id":"auto-valuation","level":0,"title":"Auto-évaluation","anchor":"#auto-valuation"},{"id":"conclusion-de-la-partie","level":0,"title":"Conclusion de la partie","anchor":"#conclusion-de-la-partie"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Chapitre 7 : L'&Eacute;preuve du Feu : Tests d'Int&eacute;gration Complets (L'essentiel) | Java Spring Test"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Java Spring Test Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/007-00-integration-testing.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Chapitre 7 : L'&Eacute;preuve du Feu : Tests d'Int&eacute;gration Complets (L'essentiel) | Java Spring Test"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/007-00-integration-testing.html#webpage",
    "url": "writerside-documentation/007-00-integration-testing.html",
    "name": "Chapitre 7 : L'&Eacute;preuve du Feu : Tests d'Int&eacute;gration Complets (L'essentiel) | Java Spring Test",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Java Spring Test Help"
}</script><!-- End Schema.org --></head><body data-id="007-00-integration-testing" data-main-title="Chapitre 7 : L'Épreuve du Feu : Tests d'Intégration Complets (L'essentiel)" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs=""><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Java Spring Test  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="007-00-integration-testing" id="007-00-integration-testing.md">Chapitre 7 : L'Épreuve du Feu : Tests d'Intégration Complets (L'essentiel)</h1><section class="chapter"><h2 id="objectifs-p-dagogiques" data-toc="objectifs-p-dagogiques">Objectifs p&eacute;dagogiques</h2><p id="kyi4dp_13">&Agrave; la fin de cette partie, vous serez en mesure de :</p><ul class="list _bullet" id="kyi4dp_14"><li class="list__item" id="kyi4dp_15"><p id="kyi4dp_20"><span class="control" id="kyi4dp_21">Identifier</span> les sc&eacute;narios o&ugrave; un test d'int&eacute;gration complet avec <code class="code" id="kyi4dp_22">@SpringBootTest</code> est pertinent.</p></li><li class="list__item" id="kyi4dp_16"><p id="kyi4dp_23"><span class="control" id="kyi4dp_24">&Eacute;crire</span> un test qui simule un flux complet, du contr&ocirc;leur &agrave; la base de donn&eacute;es.</p></li><li class="list__item" id="kyi4dp_17"><p id="kyi4dp_25"><span class="control" id="kyi4dp_26">Utiliser</span> <code class="code" id="kyi4dp_27">TestRestTemplate</code> pour effectuer de r&eacute;els appels HTTP sur votre application en cours d'ex&eacute;cution.</p></li><li class="list__item" id="kyi4dp_18"><p id="kyi4dp_28"><span class="control" id="kyi4dp_29">Comparer</span> l'approche <code class="code" id="kyi4dp_30">MockMvc</code> avec l'approche <code class="code" id="kyi4dp_31">TestRestTemplate</code>.</p></li><li class="list__item" id="kyi4dp_19"><p id="kyi4dp_32"><span class="control" id="kyi4dp_33">Appr&eacute;cier</span> les avantages et les inconv&eacute;nients de ce type de test (r&eacute;alisme vs. lenteur).</p></li></ul></section><section class="chapter"><h2 id="introduction-le-grand-final-de-la-r-p-tition-g-n-rale" data-toc="introduction-le-grand-final-de-la-r-p-tition-g-n-rale">Introduction : Le grand final de la r&eacute;p&eacute;tition g&eacute;n&eacute;rale</h2><p id="kyi4dp_34">Imaginez que notre application est une troupe de th&eacute;&acirc;tre.</p><ul class="list _bullet" id="kyi4dp_35"><li class="list__item" id="kyi4dp_38"><p id="kyi4dp_41">Chapitre 4 : Nous avons test&eacute; chaque acteur (<code class="code" id="kyi4dp_42">Service</code>) individuellement pour s'assurer qu'il connaissait son texte.</p></li><li class="list__item" id="kyi4dp_39"><p id="kyi4dp_43">Chapitre 5 : Nous avons test&eacute; le metteur en sc&egrave;ne (<code class="code" id="kyi4dp_44">Controller</code>) avec des doublures pour les acteurs, pour v&eacute;rifier qu'il donnait les bonnes instructions.</p></li><li class="list__item" id="kyi4dp_40"><p id="kyi4dp_45">Chapitre 6 : Nous avons test&eacute; les machinistes (<code class="code" id="kyi4dp_46">Repository</code>) pour &ecirc;tre s&ucirc;rs qu'ils pouvaient changer les d&eacute;cors (<code class="code" id="kyi4dp_47">BDD</code>) correctement.</p></li></ul><p id="kyi4dp_36">Chaque test &eacute;tait isol&eacute;, focalis&eacute;. Mais maintenant, c'est l'heure de la <span class="control" id="kyi4dp_48">r&eacute;p&eacute;tition g&eacute;n&eacute;rale</span>. On allume les projecteurs, on met les vrais acteurs sur sc&egrave;ne avec les vrais d&eacute;cors, et on joue une sc&egrave;ne enti&egrave;re, de l'ouverture du rideau au salut final. On veut s'assurer que tout s'encha&icirc;ne parfaitement, que les acteurs interagissent bien entre eux et avec les d&eacute;cors.</p><p id="kyi4dp_37">Un test d'int&eacute;gration complet avec <code class="code" id="kyi4dp_49">@SpringBootTest</code> et un serveur web r&eacute;el, c'est exactement cela. On d&eacute;marre (presque) toute l'application et on teste un flux m&eacute;tier complet, de la requ&ecirc;te HTTP entrante jusqu'&agrave; la modification des donn&eacute;es en base, et vice-versa.</p></section><section class="chapter"><h2 id="quand-utiliser-springboottest-pour-un-test-complet" data-toc="quand-utiliser-springboottest-pour-un-test-complet">Quand utiliser <code class="code" id="kyi4dp_55">@SpringBootTest</code> pour un test complet ?</h2><p id="kyi4dp_51">Ce type de test est le plus haut niveau de la pyramide des tests (avant les tests E2E qui incluent l'UI). Il est lent, lourd, mais il offre le plus haut niveau de confiance. Utilisez-le avec parcimonie pour vos <span class="control" id="kyi4dp_56">sc&eacute;narios les plus critiques</span>, les &quot;happy paths&quot; qui d&eacute;finissent la valeur de votre application.</p><p id="kyi4dp_52"><span class="control" id="kyi4dp_57">Bons candidats pour un test d'int&eacute;gration complet :</span></p><ul class="list _bullet" id="kyi4dp_53"><li class="list__item" id="kyi4dp_58"><p id="kyi4dp_62">Le flux d'inscription d'un utilisateur.</p></li><li class="list__item" id="kyi4dp_59"><p id="kyi4dp_63">Le processus de passage d'une commande.</p></li><li class="list__item" id="kyi4dp_60"><p id="kyi4dp_64">La publication d'un article de blog.</p></li><li class="list__item" id="kyi4dp_61"><p id="kyi4dp_65">Un flux qui implique plusieurs services qui collaborent.</p></li></ul><p id="kyi4dp_54">Il ne s'agit pas de tester tous les cas d'erreur ici. Ces cas sont mieux couverts par des tests de tranches, plus rapides. Ici, on veut la confirmation que le &quot;chemin heureux&quot; fonctionne de A &agrave; Z.</p></section><section class="chapter"><h2 id="mise-en-place-de-l-environnement" data-toc="mise-en-place-de-l-environnement">Mise en Place de l'Environnement</h2><p id="kyi4dp_66">Pour r&eacute;aliser un test d'int&eacute;gration complet, nous allons combiner plusieurs &eacute;l&eacute;ments :</p><ol class="list _decimal" id="kyi4dp_67" type="1"><li class="list__item" id="kyi4dp_69"><p id="kyi4dp_73"><code class="code" id="kyi4dp_74">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</code>: Cette annotation d&eacute;marre un contexte Spring complet <span class="control" id="kyi4dp_75">ET</span> un vrai serveur web (Tomcat) sur un port al&eacute;atoire.</p></li><li class="list__item" id="kyi4dp_70"><p id="kyi4dp_76"><code class="code" id="kyi4dp_77">@Autowired private TestRestTemplate restTemplate;</code>: <code class="code" id="kyi4dp_78">TestRestTemplate</code> est un client HTTP fourni par Spring Boot, sp&eacute;cialement con&ccedil;u pour les tests. Contrairement &agrave; <code class="code" id="kyi4dp_79">MockMvc</code>, il effectue de <span class="control" id="kyi4dp_80">vrais appels r&eacute;seau</span> (sur <code class="code" id="kyi4dp_81">localhost</code>). Il est parfait pour dialoguer avec notre serveur d&eacute;marr&eacute; sur un port al&eacute;atoire.</p></li><li class="list__item" id="kyi4dp_71"><p id="kyi4dp_82"><code class="code" id="kyi4dp_83">@ActiveProfiles(&quot;test&quot;)</code>: Pour s'assurer que nous utilisons une configuration de test, notamment pour la base de donn&eacute;es (H2, par exemple).</p></li><li class="list__item" id="kyi4dp_72"><p id="kyi4dp_84"><code class="code" id="kyi4dp_85">@Transactional</code>: Nous pouvons toujours l'utiliser pour que la base de donn&eacute;es soit nettoy&eacute;e apr&egrave;s chaque test.</p></li></ol></section><section class="chapter"><h2 id="mockmvc-vs-testresttemplate-le-duel" data-toc="mockmvc-vs-testresttemplate-le-duel"><code class="code" id="kyi4dp_88">MockMvc</code> vs. <code class="code" id="kyi4dp_89">TestRestTemplate</code>: Le Duel</h2><div class="table-wrapper"><table class="wide" id="kyi4dp_87"><thead><tr class="ijRowHead" id="kyi4dp_90"><th id="kyi4dp_98"><p>Caract&eacute;ristique</p></th><th id="kyi4dp_99"><p><code class="code" id="kyi4dp_101">MockMvc</code> (<code class="code" id="kyi4dp_102">@WebMvcTest</code>)</p></th><th id="kyi4dp_100"><p><code class="code" id="kyi4dp_103">TestRestTemplate</code> (<code class="code" id="kyi4dp_104">@SpringBootTest(webEnvironment=...)</code>)</p></th></tr></thead><tbody><tr id="kyi4dp_91"><td id="kyi4dp_105"><p><span class="control" id="kyi4dp_108">Type d'appel</span></p></td><td id="kyi4dp_106"><p>Simul&eacute;, dans le processus. Pas de socket r&eacute;seau.</p></td><td id="kyi4dp_107"><p><span class="control" id="kyi4dp_109">Appel HTTP r&eacute;el</span> sur <code class="code" id="kyi4dp_110">localhost</code>.</p></td></tr><tr id="kyi4dp_92"><td id="kyi4dp_111"><p><span class="control" id="kyi4dp_114">Serveur Web</span></p></td><td id="kyi4dp_112"><p>Le serveur (Tomcat) n'est pas d&eacute;marr&eacute;.</p></td><td id="kyi4dp_113"><p>Un <span class="control" id="kyi4dp_115">vrai serveur</span> est d&eacute;marr&eacute;.</p></td></tr><tr id="kyi4dp_93"><td id="kyi4dp_116"><p><span class="control" id="kyi4dp_119">Contexte Spring</span></p></td><td id="kyi4dp_117"><p>Partiel (couche web uniquement).</p></td><td id="kyi4dp_118"><p><span class="control" id="kyi4dp_120">Complet</span> (ou presque).</p></td></tr><tr id="kyi4dp_94"><td id="kyi4dp_121"><p><span class="control" id="kyi4dp_124">Vitesse</span></p></td><td id="kyi4dp_122"><p><span class="control" id="kyi4dp_125">Rapide</span>.</p></td><td id="kyi4dp_123"><p><span class="control" id="kyi4dp_126">Lent</span>.</p></td></tr><tr id="kyi4dp_95"><td id="kyi4dp_127"><p><span class="control" id="kyi4dp_130">Test de...</span></p></td><td id="kyi4dp_128"><p>Principalement le contr&ocirc;leur et la couche web (filtres, s&eacute;rialisation).</p></td><td id="kyi4dp_129"><p>Le <span class="control" id="kyi4dp_131">flux complet</span> &agrave; travers toutes les couches.</p></td></tr><tr id="kyi4dp_96"><td id="kyi4dp_132"><p><span class="control" id="kyi4dp_135">Syntaxe</span></p></td><td id="kyi4dp_133"><p>Fluide, avec des <code class="code" id="kyi4dp_136">perform</code> et des <code class="code" id="kyi4dp_137">andExpect</code>.</p></td><td id="kyi4dp_134"><p>Plus &quot;brute&quot;, similaire &agrave; <code class="code" id="kyi4dp_138">RestTemplate</code>.</p></td></tr><tr id="kyi4dp_97"><td id="kyi4dp_139"><p><span class="control" id="kyi4dp_142">Id&eacute;al pour...</span></p></td><td id="kyi4dp_140"><p>Tester les contr&ocirc;leurs en isolation.</p></td><td id="kyi4dp_141"><p>Tester les sc&eacute;narios critiques de bout en bout.</p></td></tr></tbody></table></div></section><section class="chapter"><h2 id="exemple-tester-le-flux-de-cr-ation-de-livre" data-toc="exemple-tester-le-flux-de-cr-ation-de-livre">Exemple : Tester le flux de cr&eacute;ation de livre</h2><p id="kyi4dp_143">Reprenons notre exemple de cr&eacute;ation de livre. Nous allons tester le flux complet :</p><ol class="list _decimal" id="kyi4dp_144" type="1"><li class="list__item" id="kyi4dp_147"><p id="kyi4dp_152">Un client envoie une requ&ecirc;te <code class="code" id="kyi4dp_153">POST</code> sur <code class="code" id="kyi4dp_154">/api/books</code>.</p></li><li class="list__item" id="kyi4dp_148"><p id="kyi4dp_155">Le <code class="code" id="kyi4dp_156">BookController</code> la re&ccedil;oit.</p></li><li class="list__item" id="kyi4dp_149"><p id="kyi4dp_157">Il la transmet au <code class="code" id="kyi4dp_158">BookService</code>.</p></li><li class="list__item" id="kyi4dp_150"><p id="kyi4dp_159">Le <code class="code" id="kyi4dp_160">BookService</code> la valide et l'envoie au <code class="code" id="kyi4dp_161">BookRepository</code>.</p></li><li class="list__item" id="kyi4dp_151"><p id="kyi4dp_162">Le <code class="code" id="kyi4dp_163">BookRepository</code> l'ins&egrave;re dans la base de donn&eacute;es H2.</p></li></ol><div class="code-block" data-lang="java">
// src/test/java/fr/formation/spring/integration/BookFlowIntegrationTest.java
package fr.formation.spring.integration;

import fr.formation.spring.api.dto.CreateBookDto;
import fr.formation.spring.entity.Book;
import fr.formation.spring.repository.BookRepository;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.ActiveProfiles;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles(&quot;test&quot;)
class BookFlowIntegrationTest {

    @Autowired
    private TestRestTemplate restTemplate;

    @Autowired
    private BookRepository bookRepository; // On l'injecte pour vérifier la BDD

    // On nettoie la BDD après chaque test car nous n'utilisons pas @Transactional
    // pour que les données soient vraiment commitées.
    @AfterEach
    void tearDown() {
        bookRepository.deleteAll();
    }

    @Test
    void createBook_flow_shouldCreateBookInDatabase() {
        // Arrange
        CreateBookDto newBookDto = new CreateBookDto(&quot;Le Fléau&quot;, &quot;Stephen King&quot;);
        long countBefore = bookRepository.count();

        // Act
        // On fait un vrai appel POST
        ResponseEntity&lt;Book&gt; response = restTemplate.postForEntity(
                &quot;/api/books&quot;,
                newBookDto,
                Book.class
        );

        // Assert
        // 1. Vérifier la réponse HTTP
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.CREATED);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().getTitle()).isEqualTo(&quot;Le Fléau&quot;);
        assertThat(response.getBody().getId()).isNotNull();

        // 2. Vérifier directement en base de données (la preuve ultime)
        long countAfter = bookRepository.count();
        assertThat(countAfter).isEqualTo(countBefore + 1);

        Book bookInDb = bookRepository.findById(response.getBody().getId()).orElseThrow();
        assertThat(bookInDb.getAuthor()).isEqualTo(&quot;Stephen King&quot;);
    }
}
</div><aside class="prompt" data-type="warning" data-title="" id="kyi4dp_146"><p>**`@Transactional` et `TestRestTemplate`** Attention, le `@Transactional` avec son rollback par d&eacute;faut pose probl&egrave;me ici. La transaction du test et la transaction de l'application (d&eacute;clench&eacute;e par l'appel HTTP) sont deux transactions diff&eacute;rentes. Les donn&eacute;es ins&eacute;r&eacute;es par l'application ne seraient pas visibles par le test. Une solution simple est de ne pas utiliser `@Transactional` et de nettoyer la base manuellement avec `@AfterEach` comme dans l'exemple.</p></aside></section><section class="chapter"><h2 id="exercice-10-tester-un-flux-de-recherche" data-toc="exercice-10-tester-un-flux-de-recherche">Exercice 10 : Tester un flux de recherche</h2><p id="kyi4dp_164">Vous allez tester le flux complet de la recherche d'un livre par son ID.</p><ol class="list _decimal" id="kyi4dp_165" type="1"><li class="list__item" id="kyi4dp_166"><p id="kyi4dp_173">Cr&eacute;ez une classe de test <code class="code" id="kyi4dp_174">BookSearchIntegrationTest</code>.</p></li><li class="list__item" id="kyi4dp_167"><p id="kyi4dp_175">Annotez-la pour d&eacute;marrer un serveur sur un port al&eacute;atoire et utiliser le profil &quot;test&quot;.</p></li><li class="list__item" id="kyi4dp_168"><p id="kyi4dp_176">Injectez <code class="code" id="kyi4dp_177">TestRestTemplate</code> et <code class="code" id="kyi4dp_178">BookRepository</code>.</p></li><li class="list__item" id="kyi4dp_169"><p id="kyi4dp_179">Dans une m&eacute;thode de test, commencez par ins&eacute;rer directement un livre dans la base de donn&eacute;es en utilisant le <code class="code" id="kyi4dp_180">BookRepository</code> (c'est notre &eacute;tat initial).</p></li><li class="list__item" id="kyi4dp_170"><p id="kyi4dp_181">Utilisez <code class="code" id="kyi4dp_182">TestRestTemplate</code> pour faire un appel <code class="code" id="kyi4dp_183">GET</code> &agrave; l'endpoint <code class="code" id="kyi4dp_184">/api/books/{id}</code> avec l'ID du livre que vous venez de cr&eacute;er.</p></li><li class="list__item" id="kyi4dp_171"><p id="kyi4dp_185">V&eacute;rifiez que la r&eacute;ponse a un statut <code class="code" id="kyi4dp_186">200 OK</code>.</p></li><li class="list__item" id="kyi4dp_172"><p id="kyi4dp_187">V&eacute;rifiez que le corps de la r&eacute;ponse n'est pas nul et que le titre du livre dans la r&eacute;ponse correspond &agrave; celui que vous avez ins&eacute;r&eacute;.</p></li></ol></section><section class="chapter"><div class="collapse"><div class="collapse__title"><h2 id="correction-exercice-10" data-toc="correction-exercice-10">Correction exercice 10</h2></div><div class="collapse__content"><div class="code-block" data-lang="java">
// src/test/java/fr/formation/spring/integration/BookSearchIntegrationTest.java
package fr.formation.spring.integration;

import fr.formation.spring.entity.Book;
import fr.formation.spring.repository.BookRepository;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.ActiveProfiles;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles(&quot;test&quot;)
class BookSearchIntegrationTest {

    @Autowired
    private TestRestTemplate restTemplate;

    @Autowired
    private BookRepository bookRepository;

    private Book testBook;

    // On prépare les données avant chaque test
    @BeforeEach
    void setUp() {
        bookRepository.deleteAll(); // On nettoie au cas où
        Book book = new Book(&quot;Ça&quot;, &quot;Stephen King&quot;);
        testBook = bookRepository.save(book);
    }

    @Test
    void getBookById_flow_shouldReturnExistingBook() {
        // Arrange : le livre est déjà en BDD grâce au setUp

        // Act
        ResponseEntity&lt;Book&gt; response = restTemplate.getForEntity(
                &quot;/api/books/{id}&quot;,
                Book.class,
                testBook.getId() // On passe l'ID comme variable d'URL
        );

        // Assert
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isNotNull();
        assertThat(response.getBody().getId()).isEqualTo(testBook.getId());
        assertThat(response.getBody().getTitle()).isEqualTo(&quot;Ça&quot;);
    }
}
</div></div></div></section><section class="chapter"><h2 id="auto-valuation" data-toc="auto-valuation">Auto-&eacute;valuation</h2><ol class="list _decimal" id="kyi4dp_189" type="1"><li class="list__item" id="kyi4dp_191"><p id="kyi4dp_196">(Question ouverte) D&eacute;crivez un sc&eacute;nario d'application pour lequel un test d'int&eacute;gration complet serait plus pertinent qu'un test en tranche.</p></li><li class="list__item" id="kyi4dp_192"><p id="kyi4dp_197">(QCM) Quelle est la principale diff&eacute;rence entre <code class="code" id="kyi4dp_199">MockMvc</code> et <code class="code" id="kyi4dp_200">TestRestTemplate</code>?</p><ul class="list _bullet" id="kyi4dp_198"><li class="list__item" id="kyi4dp_201"><p id="kyi4dp_205">a) <code class="code" id="kyi4dp_206">MockMvc</code> est plus rapide car il ne d&eacute;marre pas de serveur web.</p></li><li class="list__item" id="kyi4dp_202"><p id="kyi4dp_207">b) <code class="code" id="kyi4dp_208">TestRestTemplate</code> ne peut pas &ecirc;tre utilis&eacute; avec <code class="code" id="kyi4dp_209">@SpringBootTest</code>.</p></li><li class="list__item" id="kyi4dp_203"><p id="kyi4dp_210">c) <code class="code" id="kyi4dp_211">MockMvc</code> ne peut tester que des endpoints <code class="code" id="kyi4dp_212">GET</code>.</p></li><li class="list__item" id="kyi4dp_204"><p id="kyi4dp_213">d) <code class="code" id="kyi4dp_214">TestRestTemplate</code> ne peut pas envoyer de corps de requ&ecirc;te.</p></li></ul></li><li class="list__item" id="kyi4dp_193"><p id="kyi4dp_215">(Question ouverte) Pourquoi l'annotation <code class="code" id="kyi4dp_216">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</code> est-elle particuli&egrave;rement bien adapt&eacute;e aux tests d'int&eacute;gration complets ?</p></li><li class="list__item" id="kyi4dp_194"><p id="kyi4dp_217">(QCM) Dans un test d'int&eacute;gration complet qui effectue une &eacute;criture en base de donn&eacute;es, pourquoi est-il souvent pr&eacute;f&eacute;rable de nettoyer la base avec <code class="code" id="kyi4dp_219">@AfterEach</code> plut&ocirc;t que de se fier au <code class="code" id="kyi4dp_220">@Transactional</code> par d&eacute;faut ?</p><ul class="list _bullet" id="kyi4dp_218"><li class="list__item" id="kyi4dp_221"><p id="kyi4dp_225">a) Parce que <code class="code" id="kyi4dp_226">@Transactional</code> ne fonctionne pas avec H2.</p></li><li class="list__item" id="kyi4dp_222"><p id="kyi4dp_227">b) Parce que l'appel HTTP se fait dans une transaction s&eacute;par&eacute;e de celle du test, rendant le rollback inefficace pour ce sc&eacute;nario.</p></li><li class="list__item" id="kyi4dp_223"><p id="kyi4dp_228">c) Parce que <code class="code" id="kyi4dp_229">@AfterEach</code> est plus rapide que <code class="code" id="kyi4dp_230">@Transactional</code>.</p></li><li class="list__item" id="kyi4dp_224"><p id="kyi4dp_231">d) Parce que <code class="code" id="kyi4dp_232">@Transactional</code> n'est pas compatible avec <code class="code" id="kyi4dp_233">@SpringBootTest</code>.</p></li></ul></li><li class="list__item" id="kyi4dp_195"><p id="kyi4dp_234">(QCM) L'objectif principal d'un test d'int&eacute;gration complet est de :</p><ul class="list _bullet" id="kyi4dp_235"><li class="list__item" id="kyi4dp_236"><p id="kyi4dp_240">a) Tester tous les cas d'erreur et les branches de code d'un service.</p></li><li class="list__item" id="kyi4dp_237"><p id="kyi4dp_241">b) V&eacute;rifier que les composants de l'application (contr&ocirc;leur, service, repository) collaborent correctement pour un flux m&eacute;tier critique.</p></li><li class="list__item" id="kyi4dp_238"><p id="kyi4dp_242">c) Tester l'interface utilisateur.</p></li><li class="list__item" id="kyi4dp_239"><p id="kyi4dp_243">d) Remplacer les tests unitaires.</p></li></ul></li></ol><p id="kyi4dp_190"><span class="emphasis" id="kyi4dp_244">(Les corrections de l'auto-&eacute;valuation seront fournies &agrave; la toute fin du support de cours.)</span></p></section><section class="chapter"><h2 id="conclusion-de-la-partie" data-toc="conclusion-de-la-partie">Conclusion de la partie</h2><p id="kyi4dp_245">Vous avez atteint le sommet de la pyramide des tests (au sein de votre service) ! Vous savez maintenant comment mener la &quot;r&eacute;p&eacute;tition g&eacute;n&eacute;rale&quot; de votre application en testant des flux complets. Vous avez appris &agrave; utiliser <code class="code" id="kyi4dp_247">@SpringBootTest</code> avec un vrai serveur web et &agrave; interagir avec lui via <code class="code" id="kyi4dp_248">TestRestTemplate</code>. Vous comprenez surtout les compromis : ces tests sont une ressource pr&eacute;cieuse car ils sont tr&egrave;s r&eacute;alistes, mais ils sont aussi co&ucirc;teux &agrave; ex&eacute;cuter. Il faut donc les r&eacute;server pour vos sc&eacute;narios les plus importants.</p><p id="kyi4dp_246">Cette comp&eacute;tence est essentielle, mais le monde r&eacute;el nous confronte souvent &agrave; un autre d&eacute;fi : comment tester notre application lorsqu'elle d&eacute;pend de services externes (une autre base de donn&eacute;es, un service de messagerie, une autre API) ? C'est le sujet de notre prochain chapitre, o&ugrave; nous d&eacute;couvrirons la magie de Testcontainers.</p></section><div class="last-modified">16 juin 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="006-00-database-testing.html" class="navigation-links__prev">Chapitre 6 : Tester les Fondations : La Couche d'Acc&egrave;s aux Donn&eacute;es (L'essentiel)</a><a href="008-00-testcontainers.html" class="navigation-links__next">Chapitre 8 : Le Test en Conditions R&eacute;elles : G&eacute;rer les D&eacute;pendances Externes avec Testcontainers (L'essentiel)</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>