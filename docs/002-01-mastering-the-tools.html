<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-06-27T16:25:10.780191"><title>Chapitre 2 : Ma&icirc;triser Votre Bo&icirc;te &agrave; Outils de Test (Pour aller plus loin) | Java Spring Test</title><script type="application/json" id="virtual-toc-data">[{"id":"objectifs-p-dagogiques","level":0,"title":"Objectifs pédagogiques","anchor":"#objectifs-p-dagogiques"},{"id":"introduction-de-l-artisan-l-artiste","level":0,"title":"Introduction : De l\u0027artisan à l\u0027artiste","anchor":"#introduction-de-l-artisan-l-artiste"},{"id":"junit-5-organiser-et-dynamiser-vos-sc-narios","level":0,"title":"JUnit 5 : Organiser et Dynamiser Vos Scénarios","anchor":"#junit-5-organiser-et-dynamiser-vos-sc-narios"},{"id":"mockito-au-del-du-simple-thenreturn","level":0,"title":"Mockito : Au-delà du Simple thenReturn","anchor":"#mockito-au-del-du-simple-thenreturn"},{"id":"assertj-des-assertions-chirurgicales","level":0,"title":"AssertJ : Des Assertions Chirurgicales","anchor":"#assertj-des-assertions-chirurgicales"},{"id":"exercice-4-combiner-les-techniques-avanc-es","level":0,"title":"Exercice 4 : Combiner les techniques avancées","anchor":"#exercice-4-combiner-les-techniques-avanc-es"},{"id":"correction-exercice-4","level":0,"title":"Correction exercice 4","anchor":"#correction-exercice-4"},{"id":"auto-valuation","level":0,"title":"Auto-évaluation","anchor":"#auto-valuation"},{"id":"conclusion-de-la-partie","level":0,"title":"Conclusion de la partie","anchor":"#conclusion-de-la-partie"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Chapitre 2 : Ma&icirc;triser Votre Bo&icirc;te &agrave; Outils de Test (Pour aller plus loin) | Java Spring Test"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Java Spring Test Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/002-01-mastering-the-tools.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Chapitre 2 : Ma&icirc;triser Votre Bo&icirc;te &agrave; Outils de Test (Pour aller plus loin) | Java Spring Test"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/002-01-mastering-the-tools.html#webpage",
    "url": "writerside-documentation/002-01-mastering-the-tools.html",
    "name": "Chapitre 2 : Ma&icirc;triser Votre Bo&icirc;te &agrave; Outils de Test (Pour aller plus loin) | Java Spring Test",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Java Spring Test Help"
}</script><!-- End Schema.org --></head><body data-id="002-01-mastering-the-tools" data-main-title="Chapitre 2 : Maîtriser Votre Boîte à Outils de Test (Pour aller plus loin)" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="002-00-tools.md|Chapitre 2 : Les Outils Essentiels du Testeur Java (L'essentiel)"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Java Spring Test  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="002-01-mastering-the-tools" id="002-01-mastering-the-tools.md">Chapitre 2 : Maîtriser Votre Boîte à Outils de Test (Pour aller plus loin)</h1><section class="chapter"><h2 id="objectifs-p-dagogiques" data-toc="objectifs-p-dagogiques">Objectifs p&eacute;dagogiques</h2><p id="z5p0z4c_12">&Agrave; la fin de cette partie, vous serez capable de :</p><ul class="list _bullet" id="z5p0z4c_13"><li class="list__item" id="z5p0z4c_14"><p id="z5p0z4c_19"><span class="control" id="z5p0z4c_20">Structurer</span> des tests complexes de mani&egrave;re lisible avec les classes imbriqu&eacute;es (<code class="code" id="z5p0z4c_21">@Nested</code>).</p></li><li class="list__item" id="z5p0z4c_15"><p id="z5p0z4c_22"><span class="control" id="z5p0z4c_23">Capturer</span> et <span class="control" id="z5p0z4c_24">inspecter</span> les arguments pass&eacute;s &agrave; vos mocks avec <code class="code" id="z5p0z4c_25">ArgumentCaptor</code>.</p></li><li class="list__item" id="z5p0z4c_16"><p id="z5p0z4c_26"><span class="control" id="z5p0z4c_27">Tester</span> des m&eacute;thodes <code class="code" id="z5p0z4c_28">void</code> et manipuler des espions (<code class="code" id="z5p0z4c_29">@Spy</code>) avec Mockito.</p></li><li class="list__item" id="z5p0z4c_17"><p id="z5p0z4c_30"><span class="control" id="z5p0z4c_31">Valider</span> plusieurs propri&eacute;t&eacute;s d'un objet en une seule fois gr&acirc;ce aux &quot;soft assertions&quot; d'AssertJ.</p></li><li class="list__item" id="z5p0z4c_18"><p id="z5p0z4c_32"><span class="control" id="z5p0z4c_33">R&eacute;diger</span> des assertions puissantes sur des collections d'objets.</p></li></ul></section><section class="chapter"><h2 id="introduction-de-l-artisan-l-artiste" data-toc="introduction-de-l-artisan-l-artiste">Introduction : De l'artisan &agrave; l'artiste</h2><p id="z5p0z4c_34">Dans la partie pr&eacute;c&eacute;dente, vous avez re&ccedil;u votre caisse &agrave; outils de base. Vous savez planter un clou avec JUnit, couper une planche avec Mockito et mesurer un angle avec AssertJ. Vous pouvez d&eacute;j&agrave; construire des choses solides.</p><p id="z5p0z4c_35">Maintenant, nous allons &eacute;quiper ces outils d'accessoires de pr&eacute;cision. Nous allons apprendre les techniques qui permettent de r&eacute;aliser des finitions parfaites, de sculpter des d&eacute;tails complexes et de travailler plus efficacement. C'est la diff&eacute;rence entre un artisan qui assemble et un artiste qui cr&eacute;e. Ces techniques avanc&eacute;es vous permettront de tester des sc&eacute;narios qui vous semblaient hors de port&eacute;e, tout en gardant vos tests clairs, concis et extr&ecirc;mement puissants.</p></section><section class="chapter"><h2 id="junit-5-organiser-et-dynamiser-vos-sc-narios" data-toc="junit-5-organiser-et-dynamiser-vos-sc-narios">JUnit 5 : Organiser et Dynamiser Vos Sc&eacute;narios</h2><section class="chapter"><h3 id="organiser-avec-nested" data-toc="organiser-avec-nested">Organiser avec <code class="code" id="z5p0z4c_42">@Nested</code></h3><p id="z5p0z4c_38">Quand une classe &agrave; tester a plusieurs m&eacute;thodes ou des comportements complexes, votre classe de test peut vite devenir un fichier &eacute;norme et illisible. JUnit 5 propose une solution &eacute;l&eacute;gante : l'annotation <code class="code" id="z5p0z4c_43">@Nested</code>. Elle vous permet de cr&eacute;er des classes internes qui regroupent des tests par contexte ou par fonctionnalit&eacute;.</p><p id="z5p0z4c_39">Imaginez une classe <code class="code" id="z5p0z4c_44">UserAccount</code> avec des m&eacute;thodes pour le d&eacute;p&ocirc;t, le retrait, et la fermeture de compte.</p><div class="code-block" data-lang="java">
// Dans UserAccountTest.java
class UserAccountTest {

    @Nested
    @DisplayName(&quot;Tests pour les dépôts&quot;)
    class DepositTests {
        @Test
        void shouldIncreaseBalance_whenDepositingPositiveAmount() { /* ... */ }

        @Test
        void shouldThrowException_whenDepositingNegativeAmount() { /* ... */ }
    }

    @Nested
    @DisplayName(&quot;Tests pour les retraits&quot;)
    class WithdrawalTests {
        @Test
        void shouldDecreaseBalance_whenSufficientFunds() { /* ... */ }

        @Test
        void shouldThrowException_whenInsufficientFunds() { /* ... */ }
    }
}
</div><aside class="prompt" data-type="tip" data-title="" id="z5p0z4c_41"><p>L'utilisation de `@Nested` am&eacute;liore drastiquement la lisibilit&eacute;. Chaque classe imbriqu&eacute;e peut avoir son propre cycle de vie (`@BeforeEach`, etc.), vous permettant de cr&eacute;er des setups tr&egrave;s sp&eacute;cifiques pour chaque groupe de tests.</p></aside></section></section><section class="chapter"><h2 id="mockito-au-del-du-simple-thenreturn" data-toc="mockito-au-del-du-simple-thenreturn">Mockito : Au-del&agrave; du Simple <code class="code" id="z5p0z4c_49">thenReturn</code></h2><section class="chapter"><h3 id="tester-les-m-thodes-void-et-la-famille-do-when" data-toc="tester-les-m-thodes-void-et-la-famille-do-when">Tester les m&eacute;thodes <code class="code" id="z5p0z4c_56">void</code> et la famille <code class="code" id="z5p0z4c_57">do...when</code></h3><p id="z5p0z4c_51">Que se passe-t-il si la m&eacute;thode que vous voulez tester ne retourne rien (<code class="code" id="z5p0z4c_58">void</code>) ? Vous ne pouvez pas utiliser <code class="code" id="z5p0z4c_59">when(mock.method()).thenReturn(...)</code>.</p><p id="z5p0z4c_52">C'est l&agrave; qu'intervient la famille de m&eacute;thodes <code class="code" id="z5p0z4c_60">do...</code>.</p><ul class="list _bullet" id="z5p0z4c_53"><li class="list__item" id="z5p0z4c_61"><p id="z5p0z4c_64"><code class="code" id="z5p0z4c_65">doNothing()</code>: Ne fait rien quand une m&eacute;thode <code class="code" id="z5p0z4c_66">void</code> est appel&eacute;e.</p></li><li class="list__item" id="z5p0z4c_62"><p id="z5p0z4c_67"><code class="code" id="z5p0z4c_68">doThrow()</code>: Lance une exception quand une m&eacute;thode (y compris <code class="code" id="z5p0z4c_69">void</code>) est appel&eacute;e.</p></li><li class="list__item" id="z5p0z4c_63"><p id="z5p0z4c_70"><code class="code" id="z5p0z4c_71">doAnswer()</code>: Permet de fournir une logique de r&eacute;ponse complexe.</p></li></ul><p id="z5p0z4c_54">La syntaxe est invers&eacute;e : <code class="code" id="z5p0z4c_72">do...().when(mock).method(...)</code>.</p><div class="code-block" data-lang="java">
// Imaginons un mock de service de logging
LoggerService mockLogger = mock(LoggerService.class);

// Configure le mock pour ne rien faire quand log() est appelée.
// Utile pour s'assurer qu'aucune exception n'est lancée.
doNothing().
        .when(mockLogger)
        .log(anyString());

// Configure le mock pour lancer une exception.
doThrow(new IOException(&quot;Disk full&quot;))
        .when(mockLogger).log(anyString());
</div></section><section class="chapter"><h3 id="capturer-des-arguments-avec-argumentcaptor" data-toc="capturer-des-arguments-avec-argumentcaptor">Capturer des arguments avec <code class="code" id="z5p0z4c_79">ArgumentCaptor</code></h3><p id="z5p0z4c_74">C'est l'une des techniques les plus puissantes de Mockito. Parfois, vous ne voulez pas seulement v&eacute;rifier qu'une m&eacute;thode a &eacute;t&eacute; appel&eacute;e, mais vous voulez <span class="control" id="z5p0z4c_80">inspecter la valeur qui lui a &eacute;t&eacute; pass&eacute;e en argument</span>.</p><p id="z5p0z4c_75">Imaginons un <code class="code" id="z5p0z4c_81">UserService</code> qui, apr&egrave;s avoir cr&eacute;&eacute; un utilisateur, envoie un email de bienvenue via un <code class="code" id="z5p0z4c_82">EmailService</code>.</p><style>.theme-dark .plantuml > svg {filter: hue-rotate(180deg) invert(0.9);}div.plantuml {overflow-x: auto;}</style><div class="plantuml"><?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="218px" preserveAspectRatio="none" style="width:450px;height:218px;background:#FFFFFF;" version="1.1" viewBox="0 0 450 218" width="450px" zoomAndPan="magnify"><defs/><g><!--class EmailService--><g id="elem_EmailService"><rect codeLine="5" fill="#FFFFFF" height="61.0146" id="EmailService" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="431" x="12" y="150.03"/><ellipse cx="178.75" cy="164.03" fill="#FFFFFF" rx="9" ry="9" style="stroke:#000000;stroke-width:1.0;"/><path d="M174.6777,159.7951 L174.6777,157.6369 L182.0571,157.6369 L182.0571,159.7951 L179.5918,159.7951 L179.5918,167.8718 L182.0571,167.8718 L182.0571,170.03 L174.6777,170.03 L174.6777,167.8718 L177.1431,167.8718 L177.1431,159.7951 Z " fill="#000000"/><text fill="#000000" font-family="Verdana" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="90" x="196.25" y="169.5979">EmailService</text><line style="stroke:#000000;stroke-width:1.0;" x1="13" x2="442" y1="178.03" y2="178.03"/><line style="stroke:#000000;stroke-width:1.0;" x1="13" x2="442" y1="186.03" y2="186.03"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="419" x="18" y="204.1052">+sendEmail(to: String, subject: String, body: String): void</text></g><!--class UserService--><g id="elem_UserService"><rect codeLine="9" fill="#FFFFFF" height="78.0293" id="UserService" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="359" x="48" y="12"/><ellipse cx="182.75" cy="26" fill="#FFFFFF" rx="9" ry="9" style="stroke:#000000;stroke-width:1.0;"/><path d="M185.7231,31.6431 Q185.1421,31.9419 184.5029,32.0913 Q183.8638,32.2407 183.1582,32.2407 Q180.6514,32.2407 179.3315,30.5889 Q178.0117,28.937 178.0117,25.8159 Q178.0117,22.6865 179.3315,21.0347 Q180.6514,19.3828 183.1582,19.3828 Q183.8638,19.3828 184.5112,19.5322 Q185.1587,19.6816 185.7231,19.9805 L185.7231,22.7031 Q185.0923,22.1221 184.4988,21.8523 Q183.9053,21.5825 183.2744,21.5825 Q181.9297,21.5825 181.2449,22.6492 Q180.5601,23.7158 180.5601,25.8159 Q180.5601,27.9077 181.2449,28.9744 Q181.9297,30.041 183.2744,30.041 Q183.9053,30.041 184.4988,29.7712 Q185.0923,29.5015 185.7231,28.9204 Z " fill="#000000"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="82" x="200.25" y="31.5679">UserService</text><line style="stroke:#000000;stroke-width:1.0;" x1="49" x2="406" y1="40" y2="40"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="196" x="54" y="58.0752">-emailService: EmailService</text><line style="stroke:#000000;stroke-width:1.0;" x1="49" x2="406" y1="65.0146" y2="65.0146"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="347" x="54" y="83.0898">+registerUser(name: String, email: String): User</text></g><!--reverse link UserService to EmailService--><g id="link_UserService_EmailService"><path codeLine="14" d="M227.5,102.27 C227.5,121.35 227.5,132.07 227.5,149.81 " fill="none" id="UserService-backto-EmailService" style="stroke:#000000;stroke-width:1.0;"/><polygon fill="none" points="227.5,90.27,223.5,96.27,227.5,102.27,231.5,96.27,227.5,90.27" style="stroke:#000000;stroke-width:1.0;"/></g><!--SRC=[LSun3i8m30NGtQSmMn5KOkx6mC1SSO0qDM1ed2fEAm7YxhIHKDFHblz_tiGxESA-CooWJvRU1EFGTaRr66FWPeXqjbvgVXCU05WYXQknX2TdkAifZ3mD7q3SePAqQLr4Ns4znUMsHnsQ1zcuB1hVllxJjiBHSmjVW8JYHIdahILI1bKhDg61RgpJKtEm4EDeWL8oa-QJMSeDNvQhpXy0]--></g></svg></div><p id="z5p0z4c_77">Comment tester que l'email envoy&eacute; contient bien le nom du nouvel utilisateur ?</p><div class="code-block" data-lang="java">

@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    @Mock
    private EmailService mockEmailService;

    @InjectMocks
    private UserService userService;

    @Test
    void shouldSendWelcomeEmail_withCorrectUserName() {
        // Arrange
        // On crée un &quot;piège&quot; pour capturer un argument de type String
        ArgumentCaptor&lt;String&gt; bodyCaptor =
                ArgumentCaptor.forClass(String.class);

        // Act
        userService.registerUser(&quot;Alex&quot;, &quot;alex@example.com&quot;);

        // Verify &amp; Capture
        // On vérifie que sendEmail a été appelé et on capture l'argument 'body'
        verify(mockEmailService).sendEmail(
                eq(&quot;alex@example.com&quot;),
                anyString(),
                bodyCaptor.capture() // Le piège est posé ici
        );

        // Assert
        // On récupère la valeur capturée et on l'inspecte
        String emailBody = bodyCaptor.getValue();
        assertThat(emailBody).contains(&quot;Bienvenue Alex !&quot;);
    }
}
</div></section><section class="chapter"><h3 id="les-espions-spy-mocker-avec-parcimonie" data-toc="les-espions-spy-mocker-avec-parcimonie">Les espions (<code class="code" id="z5p0z4c_87">@Spy</code>) : Mocker avec parcimonie</h3><p id="z5p0z4c_84">Un <code class="code" id="z5p0z4c_88">@Mock</code> est un objet enti&egrave;rement factice. Chaque m&eacute;thode ne fait rien par d&eacute;faut. Un <code class="code" id="z5p0z4c_89">@Spy</code> est diff&eacute;rent : c'est un <span class="control" id="z5p0z4c_90">objet r&eacute;el</span> que l'on &quot;espionne&quot;. Par d&eacute;faut, <span class="control" id="z5p0z4c_91">toutes les m&eacute;thodes originales sont appel&eacute;es</span>, sauf si vous en d&eacute;cidez autrement.</p><aside class="prompt" data-type="warning" data-title="" id="z5p0z4c_85"><p>**Quand utiliser un Spy ?** Tr&egrave;s rarement ! Un spy est utile quand vous voulez tester une m&eacute;thode d'une classe, tout en utilisant le comportement r&eacute;el des autres m&eacute;thodes de cette m&ecirc;me classe. C'est souvent le signe d'une classe qui a trop de responsabilit&eacute;s et qui devrait &ecirc;tre refactoris&eacute;e.</p></aside><div class="code-block" data-lang="java">
// Création d'un spy sur un objet réel
List&lt;String&gt; realList = new ArrayList&lt;&gt;();
List&lt;String&gt; spyList = spy(realList);

// On appelle une méthode NON stubbée : la vraie méthode est appelée.
spyList.add(&quot;one&quot;);

assertThat(spyList.get(0)).isEqualTo(&quot;one&quot;);

// On stubbe une méthode spécifique.
when(spyList.size()).thenReturn(100); // Attention à la syntaxe

// Maintenant, seul l'appel à size() est &quot;mocké&quot;.
assertThat(spyList.size()).isEqualTo(100);
</div></section></section><section class="chapter"><h2 id="assertj-des-assertions-chirurgicales" data-toc="assertj-des-assertions-chirurgicales">AssertJ : Des Assertions Chirurgicales</h2><p id="z5p0z4c_92">AssertJ brille vraiment quand vous devez faire des assertions complexes.</p><section class="chapter"><h3 id="assertions-sur-les-collections" data-toc="assertions-sur-les-collections">Assertions sur les collections</h3><p id="z5p0z4c_95">Inspecter des listes ou des ensembles devient un jeu d'enfant.</p><div class="code-block" data-lang="java">
List&lt;Product&gt; products = List.of(
        new Product(&quot;p1&quot;, &quot;Laptop&quot;, 1200.0),
        new Product(&quot;p2&quot;, &quot;Mouse&quot;, 25.0),
        new Product(&quot;p3&quot;, &quot;Keyboard&quot;, 75.0)
);

// Extraire une propriété et faire une assertion dessus
assertThat(products)
    .extracting(Product::getName) // Extrait les noms
    .contains(&quot;Mouse&quot;,&quot;Laptop&quot;)
    .doesNotContain(&quot;Webcam&quot;);

// Vérifier que tous les éléments satisfont une condition
assertThat(products)
        .allMatch(p -&gt;p
        .getPrice() &gt;0,&quot;le prix doit être positif&quot;);

// Vérifier une condition pour un seul élément (avec description)
assertThat(products)
    .anySatisfy(p -&gt;{
        assertThat(p.getName()).isEqualTo(&quot;Laptop&quot;);
        assertThat(p.getPrice()).isCloseTo(1200.0,within(0.01));
    });
</div></section><section class="chapter"><h3 id="soft-assertions-ne-pas-s-arr-ter-au-premier-chec" data-toc="soft-assertions-ne-pas-s-arr-ter-au-premier-chec">Soft Assertions : Ne pas s'arr&ecirc;ter au premier &eacute;chec</h3><p id="z5p0z4c_97">Par d&eacute;faut, un test s'arr&ecirc;te &agrave; la premi&egrave;re assertion qui &eacute;choue. C'est frustrant quand on valide un objet avec plusieurs propri&eacute;t&eacute;s. Les &quot;soft assertions&quot; collectent toutes les erreurs et les rapportent &agrave; la fin.</p><div class="code-block" data-lang="java">
// Dans la classe de test

import org.assertj.core.api.SoftAssertions;
// ...

@Test
void userObjectShouldBeCorrectlyPopulated() {
    User user = userService.findById(&quot;user-123&quot;);

    SoftAssertions.assertSoftly(softly -&gt; {
        softly.assertThat(user.getFirstName()).isEqualTo(&quot;John&quot;); // Supposons que c'est &quot;Jon&quot;
        softly.assertThat(user.getLastName()).isEqualTo(&quot;Doe&quot;);
        softly.assertThat(user.getAge()).isEqualTo(30); // Supposons que c'est 31
        softly.assertThat(user.isActive()).isTrue();
    });
    // Le rapport de test montrera que le prénom ET l'âge sont incorrects,
    // au lieu de s'arrêter dès la première erreur sur le prénom.
}
</div></section></section><section class="chapter"><h2 id="exercice-4-combiner-les-techniques-avanc-es" data-toc="exercice-4-combiner-les-techniques-avanc-es">Exercice 4 : Combiner les techniques avanc&eacute;es</h2><p id="z5p0z4c_99">On reprend notre <code class="code" id="z5p0z4c_104">InvoiceService</code>. On ajoute une nouvelle contrainte : apr&egrave;s avoir calcul&eacute; une facture, si celle-ci b&eacute;n&eacute;ficie de la r&eacute;duction, une notification doit &ecirc;tre envoy&eacute;e &agrave; un <code class="code" id="z5p0z4c_105">AuditService</code> pour tracer l'&eacute;v&eacute;nement. La m&eacute;thode de calcul de la facture ne retourne que le montant, elle est <code class="code" id="z5p0z4c_106">void</code> pour la notification.</p><div class="code-block" data-lang="java">
// Nouveau service : fr.formation.spring.test.service.AuditService.java
package fr.formation.spring.test.service;

public interface AuditService {
    // Enregistre un événement dans un journal d'audit
    void recordDiscountEvent(String invoiceId, double amount, double discount);
}
</div><div class="code-block" data-lang="java">
// InvoiceService modifié
package fr.formation.spring.test.service;

public class InvoiceService {
    // ...
    private final AuditService auditService;

    public InvoiceService(ProductRepository productRepository,
                          AuditService auditService) {
        this.productRepository = productRepository;
        this.auditService = auditService;
    }

    public double calculateTotalAmount(String invoiceId, Set&lt;String&gt; productIds) {
        // ... (même logique de calcul qu'avant)
        double total = /* ... */;
        double originalTotal = total;

        if (total &gt; DISCOUNT_THRESHOLD) {
            total *= DISCOUNT_RATE;
            // Appel à l'AuditService si une réduction est appliquée
            auditService.recordDiscountEvent(
                    invoiceId, originalTotal, originalTotal - total
            );
        }
        return total;
    }
}
</div><p id="z5p0z4c_102"><span class="control" id="z5p0z4c_107">Votre mission :</span> &Eacute;crivez un test pour <code class="code" id="z5p0z4c_108">calculateTotalAmount</code> qui v&eacute;rifie le sc&eacute;nario o&ugrave; la r&eacute;duction est appliqu&eacute;e. Ce test doit :</p><ol class="list _decimal" id="z5p0z4c_103" type="1"><li class="list__item" id="z5p0z4c_109"><p id="z5p0z4c_112">Utiliser Mockito pour mocker <code class="code" id="z5p0z4c_113">ProductRepository</code> et <code class="code" id="z5p0z4c_114">AuditService</code>.</p></li><li class="list__item" id="z5p0z4c_110"><p id="z5p0z4c_115">Utiliser <code class="code" id="z5p0z4c_116">ArgumentCaptor</code> pour capturer les 3 arguments pass&eacute;s &agrave; <code class="code" id="z5p0z4c_117">auditService.recordDiscountEvent</code>.</p></li><li class="list__item" id="z5p0z4c_111"><p id="z5p0z4c_118">Utiliser AssertJ et ses &quot;soft assertions&quot; pour valider que chaque argument captur&eacute; est correct.</p></li></ol></section><section class="chapter"><div class="collapse"><div class="collapse__title"><h2 id="correction-exercice-4" data-toc="correction-exercice-4">Correction exercice 4</h2></div><div class="collapse__content"><div class="code-block" data-lang="java">
// Fichier : src/test/java/fr/formation/spring/test/service/InvoiceServiceTest.java
package fr.formation.spring.test.service;

import fr.formation.spring.test.model.Product;
import fr.formation.spring.test.repository.ProductRepository;
import org.assertj.core.api.SoftAssertions;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.List;
import java.util.Set;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.within;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
class InvoiceServiceTest {

    @Mock
    private ProductRepository productRepository;

    @Mock
    private AuditService auditService;

    @InjectMocks
    private InvoiceService invoiceService;

    // ... (le test précédent)

    @Test
    @DisplayName(&quot;Devrait notifier l'AuditService quand une réduction est appliquée&quot;)
    void shouldNotifyAuditService_whenDiscountIsApplied() {
        // Arrange
        Product p1 = new Product(&quot;p1&quot;, 100.0);
        Product p2 = new Product(&quot;p2&quot;, 100.0); // Total: 200.0
        Set&lt;String&gt; productIds = Set.of(&quot;p1&quot;, &quot;p2&quot;);
        when(productRepository.findAllById(productIds)).thenReturn(List.of(p1, p2));

        ArgumentCaptor&lt;String&gt; idCaptor = ArgumentCaptor.forClass(String.class);
        ArgumentCaptor&lt;Double&gt; amountCaptor = ArgumentCaptor.forClass(Double.class);
        ArgumentCaptor&lt;Double&gt; discountCaptor = ArgumentCaptor.forClass(Double.class);

        // Act
        double finalAmount = invoiceService.calculateTotalAmount(&quot;INV-001&quot;, productIds);

        // Assert - partie 1 : vérifier le montant retourné
        // 200 * 0.9 = 180
        assertThat(finalAmount).isCloseTo(180.0, within(0.01));

        // Verify &amp; Capture
        verify(auditService).recordDiscountEvent(
                idCaptor.capture(),
                amountCaptor.capture(),
                discountCaptor.capture()
        );

        // Assert - partie 2 : vérifier les arguments capturés avec Soft Assertions
        SoftAssertions.assertSoftly(softly -&gt; {
            softly.assertThat(idCaptor.getValue())
                    .isEqualTo(&quot;INV-001&quot;);
            softly.assertThat(amountCaptor.getValue())
                    .as(&quot;Montant original avant réduction&quot;)
                    .isCloseTo(200.0, within(0.01));
            softly.assertThat(discountCaptor.getValue())
                    .as(&quot;Montant de la réduction&quot;)
                    .isCloseTo(20.0, within(0.01));
        });
    }
}
</div></div></div></section><section class="chapter"><h2 id="auto-valuation" data-toc="auto-valuation">Auto-&eacute;valuation</h2><ol class="list _decimal" id="z5p0z4c_120" type="1"><li class="list__item" id="z5p0z4c_122"><p id="z5p0z4c_127">(Question ouverte) Dans quel cas est-il plus pertinent d'utiliser un <code class="code" id="z5p0z4c_128">@Spy</code> plut&ocirc;t qu'un <code class="code" id="z5p0z4c_129">@Mock</code>? Quel est le risque associ&eacute; ?</p></li><li class="list__item" id="z5p0z4c_123"><p id="z5p0z4c_130">(QCM) Quelle est la principale utilit&eacute; de <code class="code" id="z5p0z4c_132">ArgumentCaptor</code>?</p><ul class="list _bullet" id="z5p0z4c_131"><li class="list__item" id="z5p0z4c_133"><p id="z5p0z4c_137">a) Capturer les exceptions lanc&eacute;es par un mock.</p></li><li class="list__item" id="z5p0z4c_134"><p id="z5p0z4c_138">b) Capturer et inspecter les valeurs des arguments pass&eacute;s &agrave; une m&eacute;thode d'un mock.</p></li><li class="list__item" id="z5p0z4c_135"><p id="z5p0z4c_139">c) Remplacer les arguments d'un appel de m&eacute;thode.</p></li><li class="list__item" id="z5p0z4c_136"><p id="z5p0z4c_140">d) Capturer le temps d'ex&eacute;cution d'une m&eacute;thode.</p></li></ul></li><li class="list__item" id="z5p0z4c_124"><p id="z5p0z4c_141">(Question ouverte) Expliquez l'avantage des &quot;soft assertions&quot; d'AssertJ lors de la validation d'un objet complexe.</p></li><li class="list__item" id="z5p0z4c_125"><p id="z5p0z4c_142">(QCM) Pour organiser des tests en groupes contextuels au sein d'une m&ecirc;me classe de test, on utilise :</p><ul class="list _bullet" id="z5p0z4c_143"><li class="list__item" id="z5p0z4c_144"><p id="z5p0z4c_148">a) Des packages diff&eacute;rents.</p></li><li class="list__item" id="z5p0z4c_145"><p id="z5p0z4c_149">b) <code class="code" id="z5p0z4c_150">@TestFactory</code>.</p></li><li class="list__item" id="z5p0z4c_146"><p id="z5p0z4c_151">c) Des commentaires et une bonne nomenclature.</p></li><li class="list__item" id="z5p0z4c_147"><p id="z5p0z4c_152">d) L'annotation <code class="code" id="z5p0z4c_153">@Nested</code> sur des classes internes.</p></li></ul></li><li class="list__item" id="z5p0z4c_126"><p id="z5p0z4c_154">(QCM) Vous voulez tester une m&eacute;thode <code class="code" id="z5p0z4c_156">void</code> qui est cens&eacute;e lancer une exception dans certains cas. Quelle syntaxe Mockito utiliserez-vous ?</p><ul class="list _bullet" id="z5p0z4c_155"><li class="list__item" id="z5p0z4c_157"><p id="z5p0z4c_161">a) <code class="code" id="z5p0z4c_162">when(mock.voidMethod()).thenThrow(new MyException());</code></p></li><li class="list__item" id="z5p0z4c_158"><p id="z5p0z4c_163">b) <code class="code" id="z5p0z4c_164">expect(mock.voidMethod()).toThrow(new MyException());</code></p></li><li class="list__item" id="z5p0z4c_159"><p id="z5p0z4c_165">c) <code class="code" id="z5p0z4c_166">doThrow(new MyException()).when(mock).voidMethod();</code></p></li><li class="list__item" id="z5p0z4c_160"><p id="z5p0z4c_167">d) Il est impossible de tester les exceptions sur les m&eacute;thodes <code class="code" id="z5p0z4c_168">void</code>.</p></li></ul></li></ol><p id="z5p0z4c_121"><span class="emphasis" id="z5p0z4c_169">(Les corrections de l'auto-&eacute;valuation seront fournies &agrave; la toute fin du support de cours.)</span></p></section><section class="chapter"><h2 id="conclusion-de-la-partie" data-toc="conclusion-de-la-partie">Conclusion de la partie</h2><p id="z5p0z4c_170">F&eacute;licitations ! Vous avez ajout&eacute; des outils de haute pr&eacute;cision &agrave; votre arsenal. Vous ne vous contentez plus de v&eacute;rifier si &quot;&ccedil;a marche&quot;, vous &ecirc;tes maintenant capable de diss&eacute;quer le comportement de votre code. Vous savez <span class="control" id="z5p0z4c_172">organiser</span> vos tests (<code class="code" id="z5p0z4c_173">@Nested</code>), <span class="control" id="z5p0z4c_174">espionner</span> le dialogue entre vos objets (<code class="code" id="z5p0z4c_175">ArgumentCaptor</code>), g&eacute;rer les cas d&eacute;licats (<code class="code" id="z5p0z4c_176">do...when</code>) et produire des diagnostics d'une pr&eacute;cision chirurgicale (AssertJ avanc&eacute;, Soft Assertions).</p><p id="z5p0z4c_171">Ces comp&eacute;tences sont universelles dans l'&eacute;cosyst&egrave;me Java. Elles constituent le socle sur lequel nous allons maintenant construire. Dans le prochain chapitre, nous allons voir comment Spring Boot s'appuie sur ces outils et les sublime, en nous offrant des annotations et des utilitaires qui simplifient radicalement les tests d'int&eacute;gration. Vous &ecirc;tes pr&ecirc;ts pour la prochaine &eacute;tape : tester une v&eacute;ritable application Spring</p></section><div class="last-modified">16 juin 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="002-00-tools.html" class="navigation-links__prev">Chapitre 2 : Les Outils Essentiels du Testeur Java (L'essentiel)</a><a href="003-00-spring-boot-test.html" class="navigation-links__next">Chapitre 3 : L'Int&eacute;gration Transparente : Tester avec Spring Boot (L'essentiel)</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>